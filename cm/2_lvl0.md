# 2. Класи LVL0 

**(CLSID=16#000x – 16#07FF)**

## Загальний опис 
LVL0 – рівень абстрагування від обладнання, канали контролеру. Призначений для:

- діагностування каналу: загальна помилка, помилка обриву, помилка КЗ 
- зворотній зв'язок з прив'язування технологічних змінних до каналів (PONG)
- форсування значення

 Представлений 5-ма класами:

- [CHDI](2_chdi.md) (CLSID=16#001x) – дискретні вхідні канали,
- [CHDO](2_chdo.md) (CLSID=16#002x) – дискретні вихідні канали,
- [CHAI](2_chai.md) (CLSID=16#003x) – аналогові вхідні канали,
- [CHAO](2_chao.md) (CLSID=16#004x) – аналогові вихідні канали,
- [CHCOM]() (CLSID=16\#005x) – комунікаційні канали:

## Рекомендації щодо використання в HMI

Для економії змінних рекомендується:

- використовувати одну буферну змінну CH_BUF на всі канали 
- використовувати клас [MODULS](2_moduls.md)

Для HMI дуже важливо бачити карти ПЛК, тобто стан каналів модулів (значення, використання змінною, помилки каналів), навіть якщо вони не використовуються. Крім того нерідко потрібно форсувати значення якогось виходу, або швидко дізнатися, яка змінна використовує даний канал. Найбільш простий варіант вивести на засоби HMI скорочені змінні структуру типу CH_HMI. Однак кількість тегів, що потрібна для ПЛК великої канальності надзвичайно велика, тому проміжним варіантом є використання виведення інформації по групам каналів, наприклад по 16, або по модулям. Приклади обох варіантів показані на рис.2.5.

![Приклад відображення карт ПЛК](media/2_5.png)

_рис.2.5. Приклад відображення карт ПЛК_

## Структура класів CHDI/CHDO/CHAI/CHAO

Структура класу використовується для змінних всіх каналів. Канали з CLSID=16#00x0 призначені для каналів без специфічної діагностики, усі інші залежать від типу модуля і можуть мати свої діагностичні біти. 
### Структура CH_CFG
| Атрибут | Тип  | Біт  | Опис |
| ------- | ---- | ---- | ---- |
| ID      | UINT |      | Унікальний ідентифікатор - номер змінної. Кількість доступних каналів є останнім номером. Нумерація логічна, логіка нумерації вибирається при розробці проекту.<br />ID = 0 зарезервований для помилкових операцій. Реальні канали нумеруються з 1. |
| CLSID   | UINT |      | - DICH (CLSID=16#001x) – дискретні вхідні канали,<br/>- DOCH (CLSID=16#002x) – дискретні вихідні канали,<br/>- AICH (CLSID=16#003x) – аналогові вхідні канали,<br/>- AOCH (CLSID=16#004x) – аналогові вихідні канали. |
| STA | UINT/INT |  | Може бути набір біт типу CH_STA |
|  |  | 0 VRAW | – значення дискретного сигналу з дискретного входу або сигналу на дискретний вихід; в режимі FRC=1 може змінюватися із-зовні для DOCH |
|         |      | 1 VAL    | – значення дискретного сигналу для CM верхнього рівня: для DICH DIVAR зчитує його, для DOCH DOVAR записує в нього; в режимі FRC=1 може змінюватися із-зовні для DICH |
|         |      | 2 BAD | = 1 – є якась помилка каналу |
|      |      |3 b3||
|         |      | 4 PNG | = 1 – прийшов PING-запит від володаря, обнуляється каналом (PONG-відповідь) |
|         |      | 5 ULNK | = 1 – якщо канал використовується в технологічній змінній (прив'язаний) DIVAR/AIVAR/DOVAR/AOVAR |
|         |      | 6 MERR | = 1 – є помилка на всьому модулі (діагностична інформація) |
| | | 7 BRK | = 1 – помилка обриву каналу |
| | | 8 SHRT | = 1 – помилка КЗ або перевантаження |
| | | 9 NBD | = 1 – фізично канал не існує; наприклад, для відображення в буфері модуля MODULS для HMI |
| | | 10 b10 |  |
| | | 11 b11 |  |
| | | 12 INBUF | = 1 – змінна CH в буфері CH_BUF |
| | | 13 FRC | = 1 – значення форсоване |
| | | 14 SML | = 1 – значення імітується |
| | | 15 CMDLOAD | =1 - запит на зчитування в буфер тільки з HMI |
| CMD | INT |  | команда |
| VAL | INT |  | значення для аналогових каналів CHAI, CHAO |
| VARID | UINT |  | ID прив'язаної технологічної змінної, 0 - якшо не прив'язана |
### Структура CH\_HMI
| Атрибут | Тип  | Опис                          |
| ------- | ---- | ----------------------------- |
| STA     | INT  | INT   STA+CMD (X15 – CMDLOAD) |
| VAL     | INT  | значення                      |

### Змінна CH_BUF
Має тип CH_CFG.

## Загальні вимоги до функцій CH

### Функціональні вимоги 

- Ідентифікація каналів (ID) має йти в межах кожного класу. Кількість доступних каналів є останнім номером. Нумерація логічна, логіка нумерації вибирається при розробці проекту. ID = 0 зарезервований для помилкових операцій. Реальні канали нумеруються з 1.
- повинні відслідковуватися та бути реалізовані наступні команди
  - персональна команда з HMI: STA.CMDLOAD
  - команди: 
    - 1 - записати TRUE (тільки при форсуванні CHDI/CHDO)
    - 2 - записати FALSE (тільки при форсуванні CHDI/CHDO)
    - 3 - TOOGLE (тільки при форсуванні CHDI/CHDO)
    - 16#0100 - прочитати конфігурацію в буфер (зв'язати з буфером)    
  - широкомовні команди PLC: 
    - дефорсувати всі канали 16#4302 
- Повинна бути реалізована функція роботи з буфером.
  - Буфер рекомендується використовувати один для всіх (за винятком хіба що CHCOM).
  - Факт зайнятості буфера перевіряється за рівністю класу CLSID та ID
  - конфігурація каналe повинна зчитуватися в буфер при:
    - біті статусу STA.CMDLOAD=TRUE
    - CFG.CMD = 16#0100; 
  - при зайнятості буферу, постійно CH_CFG.VAL=CH_BUF.VAL 
- Канал повинен приймати участь в прив'язуванні до технологічної змінної
  - факт прив'язаності контролюється алгоритмом PING-PONG (див. опис нижче)
  - VARID вказує на ідентифікатор змінної, яка прив'язана до каналу
  - контроль та керування прив'язаності реалізовано в технологічних змінних xxVAR
- мають підтримуватися два режими: форсований та нефорсований (нормальний)
  - режим форсування повинен відображатися в загальному статусному біті PLC_CFG
  - у нормальному режимі значення на технологічну змінну береться з входу функції VAL
  - у нормальному режимі значення на вихід функції VAL береться з прив'язаної вихідної технологічної змінної  
  - у форсованому режимі прив'язана технологічна змінна повинна отримувати форсоване значення зі змінної CH_BUF.VAL
  - у форсованому режимі вихідний канал повинен отримувати форсоване значення зі змінної CH_BUF.VAL а не з технологічної змінної

- принаймні один біт якості CHCFG.BAD повинен оновлюватися відповідно до стану каналу, інші біти реалізовуються за можливості та необхідності 

### Алгоритм PING-PONG

Каркас передбачає гнучку прив'язку технологічних змінних до каналів. Для зручності визначення вільних каналів на карті ПЛК, канал повинен контролювати факт прив'язки (задіяння) та знати яка саме змінна ним користується. Факт задіяння сигналізується в біті ULNK (Uplink). Цей біт переприсвоює значення біту PNG (Ping-запит) на початку функції CH_FN, після чого PNG:= FALSE (Pong-відповідь). Технологічна змінна, що використовує канал (**володар**) з кожним викликом VAR_FN виставляє CH_CFG.STA.PNG:=TRUE (Ping-запит) та вказує свій ID (CH_CFG.VARID:=VAR_CFG.ID). Таким чином, якщо жодна змінна не заволодіває каналом, значення PNG, а за ним і значення ULNK для цього каналу стає рівним FALSE. Алгоритм отримав робочу назву "Пінг-Понг".


