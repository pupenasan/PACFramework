## Клас DIVAR: дискретна вхідна змінна процесу
**CLSID=16#1010**

## Загальний опис

Клас реалізовує функції оброблення сирих вхідних даних та діагностичної інформації з `DICH`. До цих функцій входить фільтрація сигналу, налаштування та обробка тривожних подій, керування форсуванням та імітацією.        

Якщо мають бути відмінності в реалізації, слід використовувати інші CLSID в форматі 16#101x

## Рекомендації щодо використання в HMI

Приклад налаштування функцій дискретних вхідних змінних на HMI наведений на рис.

![](G:\san\PLCFramework\GitVer\base\media\1_8.png)

Рис. Приклад налаштування функцій дискретних вхідних змінних на HMI.

## Загальні вимоги щодо структури змінних класів

#### DIVAR_HMI

| name | type | adr  | bit  | descr                                      |
| ---- | ---- | ---- | ---- | ------------------------------------------ |
| STA  | UINT | 0    |      | стани + біт команди завантаження DIVAR_STA |

#### DIVAR_STA

Використовується для зручності роботи в програмі

| name   | type | adr  | bit  | descr                                                        |
| ------ | ---- | ---- | ---- | ------------------------------------------------------------ |
| VRAW   | BOOL | 0    | 0    | =1 – значення дискретного сигналу з DICH                     |
| VAL    | BOOL | 0    | 1    | =1 – значення дискретної вхідної змінної після всіх перетворень, в режимі FRC=1 може змінюватися із-зовні |
| BAD    | BOOL | 0    | 2    | =1 – дані недостовірні                                       |
| ALDIS  | BOOL | 0    | 3    | =1 – тривога тимчасово виведена з експлуатації               |
| DLNK   | BOOL | 0    | 4    | =1 – якщо прив’язаний до каналу                              |
| ENBL   | BOOL | 0    | 5    | =1 – змінна задіяна  = (NOT PRM.DSBL AND  DLNK)              |
| ALM    | BOOL | 0    | 6    | =1 – активна аварійна тривога                                |
| VALPRV | BOOL | 0    | 7    | значення на попередньому циклі                               |
| STAb8  | BOOL | 0    | 8    | резерв                                                       |
| ISALM  | BOOL | 0    | 9    | дублює аналогічний з PRM (для зручності анімації)            |
| ISWRN  | BOOL | 0    | 10   | дублює аналогічний з PRM (для зручності анімації)            |
| WRN    | BOOL | 0    | 11   | =1 – активне попереджувальна тривога                         |
| INBUF  | BOOL | 0    | 12   | =1 – змінна в буфері                                         |
| FRC    | BOOL | 0    | 13   | =1 – змінна в режимі форсування                              |
| SML    | BOOL | 0    | 14   | =1 – змінна в режимі симуляції                               |
| CMDBUF | BOOL | 0    | 15   | =1 – команда завантаження в буфер                            |

#### DIVAR_CFG

Тут і далі `adr` задається як зміщення в структурі в 16-бітних словах

| name    | type | adr  | bit  | Опис                                                         |
| ------- | ---- | ---- | ---- | ------------------------------------------------------------ |
| ID      | UINT | 0    |      | Унікальний ідентифікатор                                     |
| CLSID   | UINT | 1    |      | 16#1010                                                      |
| STA     | UINT | 2    |      | статус, призначення біт як `DIVAR_STA` може бути задіяна як аналогічна структура |
| VALI    | INT  | 3    |      | для відображення значення при не форсуванні; використовується для введення значення з буфера при форсуванні?? (перевірити можливість зміни без цього поля) |
| PRM     | UINT | 4    |      | параметри конфігурації, повинні зберігатися при відключеному живленні |
| ISALM   | BOOL | 4    | 0    | =1 – задіяти як аварійну тривогу                             |
| ISWRN   | BOOL | 4    | 1    | =1 – задіяти як попереджувальну тривогу                      |
| INVERSE | BOOL | 4    | 2    | =1 – інвертувати сире значення                               |
| PRMb3   | BOOL | 4    | 3    |                                                              |
| PRMb4   | BOOL | 4    | 4    |                                                              |
| NRMVAL  | BOOL | 4    | 5    | значення норми                                               |
| QALENBL | BOOL | 4    | 6    | =1 – задіяти тривогу недостовірності каналу                  |
| DSBL    | BOOL | 4    | 7    | =1 – змінна не задіяна                                       |
| PRMb8   | BOOL | 4    | 8    |                                                              |
| PRMb9   | BOOL | 4    | 9    |                                                              |
| PRMb10  | BOOL | 4    | 10   |                                                              |
| PRMb11  | BOOL | 4    | 11   |                                                              |
| PRMb12  | BOOL | 4    | 12   |                                                              |
| PRMb13  | BOOL | 4    | 13   |                                                              |
| PRMb14  | BOOL | 4    | 14   |                                                              |
| PRMb15  | BOOL | 4    | 15   |                                                              |
| CHID    | UINT | 5    |      | Логічний номер дискретного каналу, до якого прив'язана змінна, 0 - немає прив'язки |
| STEP1   | UINT | 6    |      | номер кроку                                                  |
| T_DEASP | UINT | 7    |      | Час затримки тривоги в секундах                              |
| T_FLTSP | UINT | 8    |      | Заданий час фільтрації в мілісекундах                        |
| TMP     | UINT | 9    |      | резерв                                                       |
| T_STEP1 | TIME | 10   |      | Плинний час кроку в мс                                       |
| T_PREV  | TIME | 12   |      | час в мс з попереднього виклику, береться зі структури PLC_CFG.TQMS |

#### Команди для буферу (див. структуру буферу)

| Атрибут | Тип  | Біт  | Опис                                                         |
| ------- | ---- | ---- | ------------------------------------------------------------ |
| CMD     | UINT |      | Команди:16#0100 – прочитати конфігурація;16#0101 – записати конфігурація;16#0102 – записати конфігурація за замовченням;16#0200 – тимчасово вивести тривогу з обслуговування; 16#0201 – ввести тривогу в обслуговування;16#0300 – форсувати/дефорсувати; 16#0301 – форсувати;16#0302 – дефорсувати |

## Загальні вимоги до функцій DIVAR

### Функціональні вимоги 

#### Режими роботи

Клас DIVAR повинен підтримувати наступні режими (підрежими):

- обробка входу/імітація
- нефорсований/форсований

У будь якому режимі значення з прив'язаного каналу `DICH` записується в `STA.VRAW`.    

**Нормальний режим** роботи екземпляру класу є комбінацією підрежимів "обробка входу" та "нефорсований режим". У цьому режимі значення `STA.VAL` залежить від значення каналу `STA.VRAW`, проходячи через функції оброблення.

У режимі **імітація** `STA.SML=TRUE` значення `STA.VAL` залежить від зовнішнього алгоритму імітації і не проходить функцій обробки, змінюється CM-мами верхнього рівня (або незалежною програмою). Іншими словами `STA.VAL` не змінюється алгоритмами класу, окрім форсування. У режимі імітація також змінюється стан `STA.SML` каналу, що прив'язаний до змінної.

У режимі **форсування** (`STA.FRC=TRUE`) `STA.VAL` змінюється  тільки через налагоджувальні вікна HMI і має найвищий пріоритет. При активності біту форсування лічильник `PLC_CFG.CNTFRC` збільшується на 1.

#### Фільтрація сигналу

Фільтрація сигналу працює за наступним принципом: значення `VAL` змінюється на протилежне тільки при зміні сирого значення `VRAW` на час більше ніж  `T_FLTSP`.

#### Інвертування сигналу

При встановленні біту `PRM.INVERSE=TRUE` значення  `STA.VAL = NOT STA.VRAW ` .

#### Моніторинг прив'язки до каналу 

Значення `STA.DLNK=TRUE` вказує на факт прив'язки до каналу.

#### Активність змінної 

Параметр активності змінної визначається виразом `STA.ENBL = NOT PRM.DSBL AND DLNK`. Якщо змінна неактивна `STA.ENBL=FALSE` не працюють функції:

- перетворення сигналу з сирого значення: фільтрація, інвертування 
- діагностування та обробка тривог

#### Оброблення тривог

Доступне генерування двох класів тривог:

- аварійна тривога: активується бітом `PRM.ISALM=TRUE`
- попереджувальна тривога: активується бітом `PRM.ISWRN=TRUE` 

За необхідності можна задіяти обидва класи. При активації однієї з функцій оброблення тривог відстежується умова спрацювання:

`умова_спрацювання = VAL <> NRMVAL` 

Тривога спрацьовує якщо умова спрацювання виконується протягом часу `T_DEASP`.  Аварійна тривога відображається станом `STA.ALM=TRUE`, попереджувальна - `STA.WRN=TRUE`. 

При спрацюванні тривоги (передній фронт) виставлється відповідний біт `PLC_CFG.NWALM` та/або `PLC_CFG.NWWRN`. Поки тривога активна:

- виставляється відповідний біт `PLC_CFG.ALM` та/або `PLC_CFG.WRN` відповідно
- збільшується на 1 лічильник `PLC_CFG.CNTALM` та/або `PLC_CFG.CNTWRN` відповідно

#### Діагностування каналу вимірювання

Класом передбачається перевірка достовірності каналу вимірювання. При `PRM.QALENBL=TRUE` значення `STA.BAD` прямо залежить від значення `STA.BAD` прив'язаного каналу. Інший спосіб діагностування вимірювального каналу не передбачений даним класом змінної.

`STA.BAD` - це тривога недостовірності. При виникненні тривоги (по передньому фронту) `PLC_CFG.NWBAD=TRUE`. Поки тривога  `STA.BAD`активна:

- виставляється відповідний біт `PLC_CFG.BAD` 
- збільшується на 1 лічильник `PLC_CFG.CNTBAD` 

Скидання біту `PRM.QALENBL=FALSE` відключає функцію перевірки тривоги недостовірності.  

### Вимоги щодо реалізації інтерфейсу

ту-ду

### Вимоги щодо реалізації програми користувача

ту-ду

## Тестування 

Загальні вимоги щодо тестування наведені в документі класи LVL1. Тут приводяться тільки особливі тести, що відрізняються від загальних.

### Перелік тестів

| Номер | Назва                   | Коли перевіряти | Примітки |
| ----- | ----------------------- | --------------- | -------- |
| 1     | Тест функції фільтрації |                 |          |
| 2     | Тест інвертування       |                 |          |
| 3     | Тест функцій тривог     |                 |          |
| 4     | Тест                    |                 |          |
|       |                         |                 |          |
|       |                         |                 |          |
|       |                         |                 |          |

