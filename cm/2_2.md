## 2.2. Класи LVL0 (CLSID=16#000x – 16#07FF)
### 2.2.1. Перелік класів LVL0 та їх призначення
LVL0 – рівень абстрагування від обладнання, канали контролеру. Призначений для діагностування каналу, прив'язки логічних каналів до фізичних: 
- DICH (CLSID=16#001x) – дискретні вхідні канали,
- DOCH (CLSID=16#002x) – дискретні вихідні канали,
- AICH (CLSID=16#003x) – аналогові вхідні канали,
- AOCH (CLSID=16#004x) – аналогові вихідні канали,
- COMCH (CLSID=16\#005x) – комунікаційні канали:

Ідентифікація каналів (ID) йде в межах кожного класу, однак буфер рекомендується використовувати один для всіх (за винятком хіба що COMCH). Факт зайнятості буфера перевіряється за рівністю класу CLSID та ID. Зовнішня структура однакова для всіх типів.
На рис.2.4 показаний приклад структури CH_CFG та CH_BUF. У структурі CH_HMI рекомендується використовувати тільки STA (замість STA+CMD), а в CH_CFG не використовувати CMD.VAL у більшості випадків достатньо робити типу INT.

![Приклад структури CH_CFG](/media/fig2_4.png)

_рис.2.4. Приклад структури CH_CFG_
### 2.2.2. Структура класів DICH/DOCH/AICH/AOCH
Структура класу використовується для всіх каналів. Канали з CLSID=16#00X0 призначені для каналів без специфічної діагностики, усі інші залежать від типу модуля і можуть мати свої діагностичні біти. 
#### Структура CH_CFG
| Атрибут | Тип  | Біт  | Опис |
| ------- | ---- | ---- | ---- |
| ID      | UINT |      | Унікальний ідентифікатор<br />ID = 0 зарезервований для помилкових операцій |
| CLSID   | UINT |      | - DICH (CLSID=16#001x) – дискретні вхідні канали,<br/>- DOCH (CLSID=16#002x) – дискретні вихідні канали,<br/>- AICH (CLSID=16#003x) – аналогові вхідні канали,<br/>- AOCH (CLSID=16#004x) – аналогові вихідні канали. |
| STA | INT | 0 VRAW | = 1 – значення дискретного сигналу з дискретного входу |
|         |      | 1 VAL    | = 1 – значення дискретного сигналу для CM верхнього рівня, в режимі FRC=1 може змінюватися із-зовні |
|         |      | 2 BAD | = 1 – є помилка каналу |
|      |      |3||
|         |      | 4 PNG | = 1 – прийшла відповідь від володаря, обнуляється каналом |
|         |      | 5 ULNK | = 1 – якщо використовується в змінній DIVAR/AIVAR/DOVAR/AOVAR |
|         |      | 6 MERR | = 1 – є помилка модулю (діагностична інформація) |
| | | 7 BRK | = 1 – помилка обриву каналу |
| | | 8 SHRT | = 1 – помилка КЗ |
| | | 9 NBD | = 1 – фізично канал не існує; наприклад, для відображення в буфері модуля MODULS, для використання резерву каналів не прив'язаних до фізичних |
| | | 10 |  |
| | | 11 |  |
| | | 12 INBUF | = 1 – в буфері |
| | | 13 FRC | = 1 – значення форсоване |
| | | 14 SML | = 1 – значення імітується |
| | | 15 | |
| VAL | INT |  | значення |
| VARID | UINT |  | ID прив'язаної технологічної змінної |
| TMP | UINT |  | для вирівнювання (за необхідності) |
#### Структура CH\_HMI
| Атрибут | Тип  | Опис                          |
| ------- | ---- | ----------------------------- |
| STA     | INT  | INT   STA+CMD (X15 – CMDLOAD) |
| VAL     | INT  | значення                      |

Для HMI дуже важливо бачити карти ПЛК, тобто стан каналів модулів (значення, використання змінною, помилки каналів), навіть якщо вони не використовуються. Крім того нерідко потрібно форсувати значення якогось виходу, або швидко дізнатися, яка змінна використовує даний канал. Найбільш простий варіант вивести на засоби HMI скорочені змінні структуру типу CH_HMI. Однак кількість тегів, що потрібна для ПЛК великої канальності надзвичайно велика, тому проміжним варіантом є використання виведення інформації по групам каналів, наприклад по 16, або по модулям. Приклади обох варіантів показані на рис.2.5.

![Приклад відображення карт ПЛК](/media/fig2_5.png)

_рис.2.5. Приклад відображення карт ПЛК_
#### Структура CH_BUF
| Атрибут | Тип  | Біт  | Опис |
| ------- | ---- | ---- | ---- |
| ID      | UINT |      | Унікальний ідентифікатор<br />ID = 0 зарезервований для помилкових операцій |
| CLSID   | UINT |      | - DICH (CLSID=16#001x) – дискретні вхідні канали,<br/>- DOCH (CLSID=16#002x) – дискретні вихідні канали,<br/>- AICH (CLSID=16#003x) – аналогові вхідні канали,<br/>- AOCH (CLSID=16#004x) – аналогові вихідні канали. |
| STA | INT | 0 VRAW | = 1 – значення дискретного сигналу з дискретного входу |
|         |      | 1 VAL    | = 1 – значення дискретного сигналу для CM верхнього рівня, в режимі FRC = 1 може змінюватися із-зовні |
|         |      | 2 BAD | = 1 – є помилка каналу |
|      |      |3||
|         |      | 4 PNG | = 1 – прийшла відповідь від володаря, обнуляється каналом (див.2.2.4) |
|         |      | 5 ULNK | = 1 – якщо використовується в змінній DIVAR/AIVAR/DOVAR/AOVAR (див.2.2.4) |
|         |      | 6 MERR | = 1 – є помилка модулю (діагностична інформація) |
| | | 7 BRK | = 1 – помилка обриву каналу |
| | | 8 SHRT | = 1 – помилка КЗ |
| | | 9 NBD | = 1 – фізично канал не існує; наприклад, для відображення в буфері модуля MODULS, для використання резерву каналів не прив'язаних до фізичних |
| | | 10 |  |
| | | 11 |  |
| | | 12 INBUF | = 1 – в буфері |
| | | 13 FRC | = 1 – значення форсоване |
| | | 14 SML | = 1 – значення імітується |
| | | 15 CMDLOAD | = 1 – записати в буфер |
| CMD | UINT |  | Команди:<br/>16#0100 – прочитати конфігурацію<br/>16#0101 – записати конфігурацію<br/>16#0300 – форсувати/дефорсувати<br/>16#0301 – форсувати канал<br/>16#0302 – дефорсувати канал |
| VAL | INT |  | значення |
| VARID | UINT |  | ID прив'язаної технологічної змінної |

### 2.2.3. Приклад групування каналів для відображення на карті ПЛК
Нижче описаний один з варіантів реалізації роботи з групою каналів. Функції, які реалізовуються:
- постійний контроль стану (відображення) помилки каналів (хоча б одного) на модулях
- вибір групи каналу для відображення (у даному прикладі групою по 16)
-  відображення стану каналів вибраної групи, відповідно до даних з структури CH_HMI
-  завантаження в буфер будь якого каналу з групи
-  робота з каналом через буфер (форсування, зміна значення)

Приклад структури:
#### Структура MODULS
| Атрибут | Тип                        | Опис                                                         |
| ------- | -------------------------- | ------------------------------------------------------------ |
| STRTNMB | UINT                       | номер початкового каналу для відображення                    |
| CNT     | UINT                       | LOBYTE: кількість каналів (залежить від модуля), не більше 16  <br/>HIBYTE: тип каналу (1- DICH, 2- DOCH, 3- AICH, 4 – AOCH) |
| CH      | ARRAY \[1 to 16\] of CHHMI | значення відповідно до CH\_HMI                               |
| STA1    | INT                        | стани BAD модулів 1 (16 шт)                                  |
| STA2    | INT                        | стани BAD модулів 2 (16 шт)                                  |
| ...     |                            |                                                              |
| STAn    | INT                        | стани BAD модулів 3 (16 шт)                                  |

![Приклад групування каналів для відображення на карті ПЛК](/media/fig2_6.png)

рис.2.6. Приклад групування каналів для відображення на карті ПЛК.
### 2.2.4. Алгоритм визначення факту прив'язки до каналу технологічної змінної 
Каркас передбачає гнучку прив'язку технологічних змінних до каналів. Для зручності визначення вільних каналів на карті ПЛК, канал повинен контролювати факт прив'язки (задіяння) та знати яка саме змінна ним користується.

Факт задіяння сигналізується в біті ULNK (Uplink STA.5). Цей біт переприсвоює значення біту PNG (Ping-Pong STA.4) на початку функції CH_FN, після чого PNG:= FALSE. Технологічна змінна, що використовує канал (**володар**) з кожним викликом VAR_FN виставляє CH_CFG.STA.PNG:=TRUE та вказує свій ID (CH_CFG.VARID:=VAR_CFG.ID). Таким чином, якщо жодна змінна не заволодіває каналом, значення PNG а за ним і значення ULNK для цього каналу стає рівним FALSE. Алгоритм отримав робочу назву "Пінг-Понг".


