# Клас MODULS

**CLSID=16#220x**

to-do

## Загальний опис

Для HMI важливо реалізувати карти ПЛК, тобто стан каналів модулів (значення, використання змінною, помилки каналів), навіть якщо вони не використовуються. Крім того нерідко потрібно форсувати значення якогось виходу, або швидко дізнатися, яка змінна використовує даний канал. Найбільш простий варіант вивести на засоби HMI скорочені змінні структуру типу `CH_HMI`. Однак кількість тегів, що потрібна для ПЛК великої канальності надзвичайно велика, тому проміжним варіантом є використання виведення інформації по групам каналів, наприклад по 16, або по модулям. Приклади обох варіантів показані на рис.2.5.  Це якраз і реалізується за допомогою класу  [MODULS](2_moduls.md)

![Приклад відображення карт ПЛК](G:\san\PLCFramework\GitVer\cm\media\2_5.png)

_рис.2.5. Приклад відображення карт ПЛК_

Нижче описаний один з варіантів реалізації роботи з групою каналів. Функції, які реалізовуються:
- постійний контроль стану (відображення) помилки каналів (хоча б одного) на модулях
- вибір групи каналу для відображення (у даному прикладі групою по 16)
-  відображення стану каналів вибраної групи, відповідно до даних з структури CH_HMI
-  завантаження в буфер будь якого каналу з групи
-  робота з каналом через буфер (форсування, зміна значення)

## Рекомендації щодо використання в HMI



## Структура класу Module та змінні Modules

Module - фізичний модуль на плк, має до 4-х Submoduls різного типу, таким чином загальною кількістю каналів до 64. Показує відображення каналів на модуль через субмодулі SUBMODULE (групи каналів) різного типу.   

| Атрибут | Тип                 | Опис                                                         |
| ------- | ------------------- | ------------------------------------------------------------ |
| STA     | INT                 | стан/команда модуля для HMI                                  |
|         | xxxx_xxxx_xxxx_1111 | останні 4 біти відповідають за BAD конкретного субмодуля     |
|         | xxxx_xxxx_1111_xxxx | конкретний підмодуль в буфері                                |
|         | xxxx_1111_xxxx_xxxx | команда завантаження конкретного підмодуля в буфер           |
| TYPE    | INT                 | типи Submodule, комбінація в 16-комвому форматі BCD (0 - відсутній, 1- DICH, 2- DOCH, 3- AICH, 4 – AOCH, 5 - COM) |
| CHCNTS  | INT                 | кількість каналів на кожен Submodule, комбінація в 16-ковому форматі - 1 (16#XYZQ) X - для першого субмодуля |
| REZ     | INT                 | резерв                                                       |
| STRTNMB | array [0..3] of int | номер початкового каналу для відображення конкретного підмодуля |

Кількість модулів задається в змінній PLCCFG.MODULSCNT.

Усі модулі містяться в масиві MODULES. Рекомендується задати кількість елементів в масиві завідомо більше ніж модулів для можливості подальшого розширення.  

## Структура класу та змінної SUBMODULE

SUBMODULE - забезпечує відображення конкретної групи каналів в модулі. Передбачається використання його для відображення (меппінга) групи каналів. Екземпляр є буфером, куди завнтажуються необхідні канали.   

| Атрибут | Тип                      | Опис                                                         |
| ------- | ------------------------ | ------------------------------------------------------------ |
| STRTNMB | INT                      | номер початкового каналу для відображення конкретного підмодуля |
| CNT     | INT                      | кількість каналів (залежить від модуля), не більше 16        |
| TYPE    | INT                      | тип каналів (1- DICH, 2- DOCH, 3- AICH, 4 – AOCH, 5 - COM)   |
| CMD     | INT                      | команда: 1..16 - номер для завантаженння каналу в буфер      |
| CH      | ARRAY [0 to 15] of CHHMI | значення відповідно до CH\_HMI                               |

## Вимоги до функцій

### PLCMAPS

- може бути функцією без параметрів або секцією
- виставляє параметри `PLCCFG`
  - PLCCFG.DICNT
  - PLCCFG.DOCNT
  - PLCCFG.AICNT
  - PLCCFG.AOCNT
  - PLCCFG.MODULSCNT
- має запускатися при старті ПЛК
- виставляє параметри кожного модуля масиву`MODULES`
  - MODULES[i].TYPE //1- DICH, 2- DOCH, 3- AICH, 4 – AOCH, 5 - COM
  - MODULES[i].CHCNTS //кількість каналів на кожен Submodule, комбінація в 16-ковому форматі 
  - MODULES[i].STRTNMB[j] //для тих субмодулів, які існують (відповідна цифра MODULES[i].TYPE<>0) 

- у буфер SUBMODULE при старті повинен завантажитися якийсь підмодуль 

### MODULES

- може бути функцією без параметрів або секцією
- має слідкувати за командами передачі в буфер SUBMODULE з Modules[].STA
  - завнтажувати в буфер SUBMODULE: кількість каналів, тип каналів, початковий номер каналу
- має оновлювати Modules[].STA
- має забезпечувати роботу з буфером SUBMODULE
  - в залежності від типу та кількості каналів оновлювати CH
  - слідкувати за командою CMD завнтаження в буфер CH
  - 

- має викликатися в кінці основної задачі
- 

## Тестування

### Перелік тестів

- усі функції перевіряються після реалізації PLCFN, CH та їх імплементації в екземплярах

| Номер | Назва                                                     | Примітки                  |
| ----- | --------------------------------------------------------- | ------------------------- |
| 1     | ініціалізація Modules                                     | робиться на першому скані |
| 2     | Тест завантаження необхідного підмодуля в буфер SUBMODULE |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |
|       |                                                           |                           |

### 1 Ініціалізація Modules

- перед запуском перевірки ПЛК повинен бути в СТОП
- після старту ПЛК повинно:
  - MODULES заповнитися відповідними значеннями
  - буфер SUBMODULE повинен заповнитися одним із підмодулів (як правило 1-й модуль, де є входи/виходи)

### 2 Тест завантаження необхідного підмодуля в буфер SUBMODULE

| Крок | дія для перевірки                                            | результат                                                    |
| ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1    | змінити біт статусу команди завантаження існуючого модуля існуючого підмодуля | біт статусу завантаження в буфері повинен змінитися, буфер SUBMODULE повинен завантажитися відповідний підмодуль, а саме:   <br />STRTNMB<br/>CNT<br/>TYPE |
| 2    |                                                              |                                                              |
| 3    |                                                              |                                                              |