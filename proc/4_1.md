# 4. Процедурне керування.

## 4.1. Загальні підходи.

У процедурному керуванні згідно ISA-88 технологічна програма представляє собою сукупність процедур які координуючись виконують певну послідовність технологічних дій. Сама верхня процедура (процедура технологічної комірки, procedure) координує роботу процедур нижчого рівня (процедури апарату, unit procedure) які у свою чергу координують роботу операція або/та етапів (operation/phase). Більш детально див.1.2.3.

У ПЛК реалізовуються так звані апаратурні процедури, в противагу рецептурним процедурам, які тільки посилаються на апаратурні. Апаратурні процедури в каркасі передбачається реалізовувати як функції.

**Функції етапів, процедур апаратів, процедур, операцій повинні викликатися в кожному циклі незалежно і без вкладеності!**

### 4.1.1. Організація автомату станів для процедури

Згідно ISA-88 автомат станів для процедур означується довільно. Однак в рамках стандарту 2010-го року запропоновано 2 автомати станів як приклади. На рис.4.1 показаний автомат станів, який сформований з цих 2-х. До першого (класичного) варіанту доданий стан \"Запускається\" і \"Завершується\".

![](media/image30.png){width="5.899946412948381in" height="4.6875in"}

рис.4.1. Запропонований в каркасі автомат станів процедур.

Проміжні стани потрібні для синхронізації SCADA/HMI та ПЛК, а також між підсистемами (наприклад синхронізуються функції в різних ПЛК). Також проміжні стани дають можливість проводити реєстрацію переходів в журналах та базах даних.

#### PROC\_CFG

+----------+-------+------------------------------------------------------------------------------------------------------------------+
| Атрибут  | Тип   | Опис                                                                                                             |
+==========+=======+==================================================================================================================+
| ID       | INT   | ідентифікатор (може вміщувати також CLSID)                                                                       |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| STA      | INT   | **Молодший байт** відображає (як правило повторює) STEP1                                                         |
|          |       |                                                                                                                  |
|          |       | 0 -- ініціалізація (тільки при старті ПЛК)                                                                       |
|          |       |                                                                                                                  |
|          |       | 1 -- Idle (простоювання)                                                                                         |
|          |       |                                                                                                                  |
|          |       | 13 -- Starting (запускається)                                                                                    |
|          |       |                                                                                                                  |
|          |       | 2 - Running (виконується)                                                                                        |
|          |       |                                                                                                                  |
|          |       | 14- Completing (завершується)                                                                                    |
|          |       |                                                                                                                  |
|          |       | 3 -- Pausing (призупиняється)                                                                                    |
|          |       |                                                                                                                  |
|          |       | 4 -- Paused (призупинено)                                                                                        |
|          |       |                                                                                                                  |
|          |       | 5 -- Holding (утримується)                                                                                       |
|          |       |                                                                                                                  |
|          |       | 6 -- Hold (утримуване)                                                                                           |
|          |       |                                                                                                                  |
|          |       | 7 -- Restarting (перезапускається)                                                                               |
|          |       |                                                                                                                  |
|          |       | 8 -- Complete (завершено)                                                                                        |
|          |       |                                                                                                                  |
|          |       | 9 -- Stopping (зупиняється)                                                                                      |
|          |       |                                                                                                                  |
|          |       | 10 -- Stopped (зупинено)                                                                                         |
|          |       |                                                                                                                  |
|          |       | 11 -- Aborting (переривається)                                                                                   |
|          |       |                                                                                                                  |
|          |       | 12 -- Aborted (перервано)                                                                                        |
|          |       |                                                                                                                  |
|          |       | 15 -- Resuming (відновлюється)                                                                                   |
|          |       |                                                                                                                  |
|          |       | **Старший байт**                                                                                                 |
|          |       |                                                                                                                  |
|          |       | X8 TMAXERR -- помилка максимуму часу виконання                                                                   |
|          |       |                                                                                                                  |
|          |       | X9 TMINERR -- помилка мінімуму часу виконання                                                                    |
|          |       |                                                                                                                  |
|          |       | X10 ALM -- наявність помилки процедури                                                                           |
|          |       |                                                                                                                  |
|          |       | X11 SEMI - напівавтоматичний                                                                                     |
|          |       |                                                                                                                  |
|          |       | X12 INBUF -- зайнятість буферу                                                                                   |
|          |       |                                                                                                                  |
|          |       | X13 MAN -- ручний режим                                                                                          |
|          |       |                                                                                                                  |
|          |       | X14 ENBL -- дозвіл на запуск                                                                                     |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| CMD      | INT   | Команди:                                                                                                         |
|          |       |                                                                                                                  |
|          |       | 16\#0100 -- прочитати конфігурацію з буферу                                                                      |
|          |       |                                                                                                                  |
|          |       | 16\#0101 -- записати конфігурацію в буфер                                                                        |
|          |       |                                                                                                                  |
|          |       | 1 -- START (запустити процедуру)                                                                                 |
|          |       |                                                                                                                  |
|          |       | 2 -- RESUME (відновити, продовжити)                                                                              |
|          |       |                                                                                                                  |
|          |       | 3 -- PAUSE (призупинити)                                                                                         |
|          |       |                                                                                                                  |
|          |       | 4 -- RESET (скинути)                                                                                             |
|          |       |                                                                                                                  |
|          |       | 5 -- RESTART (перезапустити)                                                                                     |
|          |       |                                                                                                                  |
|          |       | 6 -- HOLD (утримувати)                                                                                           |
|          |       |                                                                                                                  |
|          |       | 7 -- STOP (зупинити виконання процедури)                                                                         |
|          |       |                                                                                                                  |
|          |       | 8 -- ABORT (перервати)                                                                                           |
|          |       |                                                                                                                  |
|          |       | 9 -- CMPLT (завершити перехідний стан -- для налагодження)                                                       |
|          |       |                                                                                                                  |
|          |       | 16\#0200 -- перейти до наступного кроку T\_STEP2 (пропустити умову переходу)                                     |
|          |       |                                                                                                                  |
|          |       | 16\#0300 -- команди підтвердження дій                                                                            |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| PRM      | INT   | бітові параметри                                                                                                 |
|          |       |                                                                                                                  |
|          |       | X7 AMAXENBL -- активувати тривогу по максимуму часу виконання                                                    |
|          |       |                                                                                                                  |
|          |       | X8 AMINENBL -- активувати тривогу по мінімуму часу виконання                                                     |
|          |       |                                                                                                                  |
|          |       | X9 HMIMIN -- =1 - відображення часу на ЛМІ в годинах/хвилинах,                                                   |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| STEP1    | INT   | крок стану (STA повторює STEP1)                                                                                  |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| STEP2    | INT   | крок всередині стану                                                                                             |
|          |       |                                                                                                                  |
|          |       | дискретність кроків по станам 1000 (15 станів -- 1000 - 15000):                                                  |
|          |       |                                                                                                                  |
|          |       | 0 -- ініціалізація (тільки при старті ПЛК)                                                                       |
|          |       |                                                                                                                  |
|          |       | 1000 -- Idle (очікує)                                                                                            |
|          |       |                                                                                                                  |
|          |       | 13000 -- Starting (запускається)                                                                                 |
|          |       |                                                                                                                  |
|          |       | 2000 - Running (виконується)                                                                                     |
|          |       |                                                                                                                  |
|          |       | 14000- Completing (завершується)                                                                                 |
|          |       |                                                                                                                  |
|          |       | 3000 -- Pausing (призупиняється)                                                                                 |
|          |       |                                                                                                                  |
|          |       | 4000 -- Paused (призупинено)                                                                                     |
|          |       |                                                                                                                  |
|          |       | 5000 -- Holding (утримується)                                                                                    |
|          |       |                                                                                                                  |
|          |       | 6000 -- Hold (утримуване)                                                                                        |
|          |       |                                                                                                                  |
|          |       | 7000 -- Restarting (перезапускається)                                                                            |
|          |       |                                                                                                                  |
|          |       | 8000 -- Complete (завершено)                                                                                     |
|          |       |                                                                                                                  |
|          |       | 9000 -- Stopping (зупиняється)                                                                                   |
|          |       |                                                                                                                  |
|          |       | 10000 -- Stopped (зупинено)                                                                                      |
|          |       |                                                                                                                  |
|          |       | 11000 -- Aborting (переривається)                                                                                |
|          |       |                                                                                                                  |
|          |       | 12000 -- Aborted (перервано)                                                                                     |
|          |       |                                                                                                                  |
|          |       | -   кроки в станах робити з дискретністю 10, щоб можна було вставляти додаткові                                  |
|          |       |                                                                                                                  |
|          |       | -   для кожного стану, в кроках робити один перший крок -- ініціалізації, в якому робляться дії один раз на цикл |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| T\_STEP1 | UDINT | час виконання процедури (знаходження в Running), в Paused як правило заморожується, в Holding обнуляється.       |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| T\_STEP2 | UDINT | час виконання кроку процедури                                                                                    |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| TMIN     | UDINT | обмеження по мінімуму часу виконання, с                                                                          |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
| TMAX     | UDINT | обмеження по максимуму часу виконання, с                                                                         |
+----------+-------+------------------------------------------------------------------------------------------------------------------+
|          |       |                                                                                                                  |
+----------+-------+------------------------------------------------------------------------------------------------------------------+

#### PROC\_HMI

Структура PROC\_HMI використовується для контролю/керування станом процедури з HMI.

PROC\_HMI

+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Атрибут  | Тип   | Опис                                                                                                                                                                                                           |
+==========+=======+================================================================================================================================================================================================================+
| STA      | INT   | Молодший байт відображає (як правило повторює) STEP1                                                                                                                                                           |
|          |       |                                                                                                                                                                                                                |
|          |       | 0 -- ініціалізація (тільки при старті ПЛК)                                                                                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | 1 -- Idle (очікує)                                                                                                                                                                                             |
|          |       |                                                                                                                                                                                                                |
|          |       | 13 -- Starting (запускається)                                                                                                                                                                                  |
|          |       |                                                                                                                                                                                                                |
|          |       | 2 - Running (виконується)                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 14- Completing (завершується)                                                                                                                                                                                  |
|          |       |                                                                                                                                                                                                                |
|          |       | 3 -- Pausing (призупиняється)                                                                                                                                                                                  |
|          |       |                                                                                                                                                                                                                |
|          |       | 4 -- Paused (призупинено)                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 5 -- Holding (утримується)                                                                                                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | 6 -- Hold (утримуване)                                                                                                                                                                                         |
|          |       |                                                                                                                                                                                                                |
|          |       | 7 -- Restarting (перезапускається)                                                                                                                                                                             |
|          |       |                                                                                                                                                                                                                |
|          |       | 8 -- Complete (завершено)                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 9 -- Stopping (зупиняється)                                                                                                                                                                                    |
|          |       |                                                                                                                                                                                                                |
|          |       | 10 -- Stopped (зупинено)                                                                                                                                                                                       |
|          |       |                                                                                                                                                                                                                |
|          |       | 11 -- Aborting (переривається)                                                                                                                                                                                 |
|          |       |                                                                                                                                                                                                                |
|          |       | 12 -- Aborted (перервано)                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | Старший байт може використовуватись для додаткових станів або комнад, а може =0                                                                                                                                |
|          |       |                                                                                                                                                                                                                |
|          |       | X8 TMAXERR -- помилка максимуму часу виконання                                                                                                                                                                 |
|          |       |                                                                                                                                                                                                                |
|          |       | X9 TMINERR -- помилка мінімуму часу виконання                                                                                                                                                                  |
|          |       |                                                                                                                                                                                                                |
|          |       | X10 ALM -- наявність помилки процедури                                                                                                                                                                         |
|          |       |                                                                                                                                                                                                                |
|          |       | X11 SEMI - напівавтоматичний                                                                                                                                                                                   |
|          |       |                                                                                                                                                                                                                |
|          |       | X12 INBUF -- зайнятість буферу                                                                                                                                                                                 |
|          |       |                                                                                                                                                                                                                |
|          |       | X13 MAN -- ручний режим                                                                                                                                                                                        |
|          |       |                                                                                                                                                                                                                |
|          |       | X14 ENBL -- дозвіл на запуск                                                                                                                                                                                   |
|          |       |                                                                                                                                                                                                                |
|          |       | X15 CMDBUF -- завантажити в буфер                                                                                                                                                                              |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CMD      | INT   | Команди:                                                                                                                                                                                                       |
|          |       |                                                                                                                                                                                                                |
|          |       | 16\#0200 -- перейти до наступного кроку T\_STEP2 (пропустити умову переходу)                                                                                                                                   |
|          |       |                                                                                                                                                                                                                |
|          |       | 16\#0100 -- прочитати конфігурацію з буферу                                                                                                                                                                    |
|          |       |                                                                                                                                                                                                                |
|          |       | 16\#0101 -- записати конфігурацію в буфер                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 1 -- START (запустити етап)                                                                                                                                                                                    |
|          |       |                                                                                                                                                                                                                |
|          |       | 2 -- RESUME зупинити виконання рецепту ()                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 3 -- PAUSE                                                                                                                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | 4 -- RESET                                                                                                                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | 5 -- RESTART                                                                                                                                                                                                   |
|          |       |                                                                                                                                                                                                                |
|          |       | 6 -- HOLD                                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 7 -- STOP                                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | 8 -- ABORT                                                                                                                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | 9 - CMPLT                                                                                                                                                                                                      |
|          |       |                                                                                                                                                                                                                |
|          |       | Для економії тегів, слово команди може бути відсутнім, тоді керування з ЛМІ буде проводитися через буферну змінну                                                                                              |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| T\_STEP1 | UDINT | час виконання процедури (знаходження в Running), в Paused як правило заморожується, в Holding обнуляється.                                                                                                     |
|          |       |                                                                                                                                                                                                                |
|          |       | Для економії тегів, час виконання процедури може бути відсутнім, або бути UINT, тоді масштабування відображення (с, хв, год) вибирається індивідуально для кожної процедури. Можна використовувати формат BCD. |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| T\_STEP2 | UDINT | час виконання кроку процедури                                                                                                                                                                                  |
|          |       |                                                                                                                                                                                                                |
|          |       | Для економії тегів, час виконання кроку може бути відсутнім, або бути UINT, тоді масштабування відображення (с, хв, год) вибирається індивідуально для кожної процедури                                        |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| STEP2    | INT   | крок всередині стану (опціонально, якщо необхідно бачити внутрішню структуру для детального журналювання)                                                                                                      |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| ALM      | INT   | старший байт PHASE\_CFG.STA (опціонально, у випадку якщо HMI має обмеження на використання масок)                                                                                                              |
+----------+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#### PROC\_CTRL

Структура PROC\_CTRL використовується для контролю та керування роботою процедури в програмі ПЛК з процедур того самого або верхнього рівня.

PROC\_CTRL

  Атрибут              Тип    Опис
-------------------- ------ -----------------------------------------------------------------------------------------------------------
  ENBL                 Bool   IN дозвіл на активацію процедури
  PAUSING\_CMPLT       Bool   IN умова переходу на PAUSED виконана
  RUNING\_CMPLT        Bool   IN процедура завершилася (спрацювала внутрішня умова завершення)
  HL\_RUNNING\_CMPLT   Bool   IN cпрацювала зовнішня умова завершення, треба опрацьовувати RUNING\_CMPLT
  RESTARTING\_CMPLT    Bool   IN умова переходу на RUNNING з HOLD виконана
  RESUMING\_CMPLT      Bool   IN умова переходу на RUNNING з RESUMING виконана
  HOLDING\_CMPLT       Bool   IN умова переходу на HOLD з RUNNING виконана
  STOPPING\_CMPLT      Bool   IN умова переходу на STOP виконана
  ABORTING\_CMPLT      Bool   IN умова переходу на ABORT виконана
  STARTING\_CMPLT      Bool   IN умова переходу на RUNNING виконана
  COMPLETING\_CMPLT    Bool   IN умова переходу на COMPLETE виконана
  CMD\_START           Bool   IN програмна команда START
  CMD\_RESUME          Bool   IN програмна команда RESUME
  CMD\_RESTART         Bool   IN програмна команда RESTART
  CMD\_PAUSE           Bool   IN програмна команда PAUSE
  CMD\_HOLD            Bool   IN програмна команда HOLD
  CMD\_STOP            Bool   IN програмна команда STOP
  CMD\_ABORT           Bool   IN програмна команда ABORT
  CMD\_RESET           Bool   IN програмна команда RESET
  STA\_RUNNING         Bool   OUT стан RUNNING
  STA\_IDLE            Bool   OUT стан IDLE
  STA\_RESUMING        Bool   OUT стан RESUMING
  STA\_PAUSING         Bool   OUT стан PAUSING
  STA\_PAUSED          Bool   OUT стан PAUSED
  STA\_HOLDING         Bool   OUT стан HOLDING
  STA\_HOLD            Bool   OUT стан HOLD
  STA\_RESTARTING      Bool   OUT стан RESTARTING
  STA\_COMPLETE        Bool   OUT стан COMPLETE
  STA\_STOPPING        Bool   OUT стан STOPPING
  STA\_STOPPED         Bool   OUT стан STOPPED
  STA\_ABORTING        Bool   OUT стан ABORTING
  STA\_ABORTED         Bool   OUT стан ABORTED
  STA\_STARTING        Bool   OUT стан STARTING
  STA\_COMPLETING      Bool   OUT стан COMPLETING
  STA\_NOTWRK          Bool   OUT стан будь з яких кінцевих станів = STA\_COMPLETE OR STA\_STOPPED OR STA\_ABORTED OR STA\_IDLE
  STA\_WRK             Bool   OUT стан будь яких з робочих станів = STA\_RUNNING OR STA\_STARTING OR STA\_COMPLETING
  DSBL\_COMPLETE       Bool   IN заборона завершення (наприклад при необхідності очікування умови переходу з процедури верхнього рівня)

#### Функція PROC\_MACH

Обробку автоматів станів процедур зручно проводити окремою функцією PROC\_MACH, яка обробляє команди від HMI або від програми керування і переводить автомат в певний стан відповідно до рис.4.1. Стан процедур зберігається у змінних типу PROC\_CFG. Стан та команди контролюються/керуються з програми через структурну змінну процедури типу PROC\_CTRL, а з HMI чрез змінну PROC\_HMI. Для конфігурування окремою процедури використовується буферна змінна. Приклад інтерфейсу функції PROC\_MACH показаний нижче.

![](media/image31.png){width="3.406813210848644in" height="5.5666951006124235in"}

рис.4.2. Інтерфейс PROC\_MACH.

Нижче наведений фрагмент коду функції для розуміння її призначення.

![](media/image32.png){width="6.409722222222222in" height="5.302083333333333in"}

рис.4.3. Фрагмент коду PROC\_MACH.

### 4.1.2. Реалізація процедур 


