```pascal
FUNCTION CTRLRECIPE_FUN_old : int
VAR_IN_OUT
	CTRLRECIPE: CTRLRECIPE;
	FORMULA: CTRLRECIPE_FORMULA;
	CTRL: PHASE_CTRL;
END_VAR
VAR
	UN_GRN: EM_CONFIG;
	UN_DS: EM_CONFIG;
	EM_500: EM_CONFIG;
	PHU_GRN: PHASE_CFG;
	PHU_MIX: PHASE_CFG;
	PH_ROUTE: PHASE_CFG;
	PH_ROUTING: PHASE_CFG;
	PH_WTRACID: PHASE_CFG;
	PH_WTRDOWN: PHASE_CFG;
	MYGRNNMB: int;
	MYFERTNMB: int;
	MYID: int;
END_VAR
MYID:= CTRLRECIPE.ID;
MYGRNNMB:=FORMULA.GRN_NMB;
MYFERTNMB:=FORMULA.FERT_NMB;

IF MYGRNNMB<>0 THEN
	UN_GRN :=  GVLEQUIP.UN_600[MYGRNNMB];
	EM_500 := GVLEQUIP.EM_500[MYGRNNMB];
	PHU_GRN := GVLPHASES.PHU_GRN600[MYGRNNMB];
	CASE MYGRNNMB OF 
		1:
		PH_ROUTE := GVLPHASES.PH_ROUTE1;
		PH_ROUTING := GVLPHASES.PH_ROUTING1;
		2:
		PH_ROUTE := GVLPHASES.PH_ROUTE2;
		PH_ROUTING := GVLPHASES.PH_ROUTING2;
		3:
		PH_ROUTE := GVLPHASES.PH_ROUTE3;
		PH_ROUTING := GVLPHASES.PH_ROUTING3;
		4:
		PH_ROUTE := GVLPHASES.PH_ROUTE4;
		PH_ROUTING := GVLPHASES.PH_ROUTING4;
		5:
		PH_ROUTE := GVLPHASES.PH_ROUTE5;
		PH_ROUTING := GVLPHASES.PH_ROUTING5;
		6:
		PH_ROUTE := GVLPHASES.PH_ROUTE6;
		PH_ROUTING := GVLPHASES.PH_ROUTING6;
		7:
		PH_ROUTE := GVLPHASES.PH_ROUTE7;
		PH_ROUTING := GVLPHASES.PH_ROUTING7;
		8:
		PH_ROUTE := GVLPHASES.PH_ROUTE8;
		PH_ROUTING := GVLPHASES.PH_ROUTING8;
		9:
		PH_ROUTE := GVLPHASES.PH_ROUTE9;
		PH_ROUTING := GVLPHASES.PH_ROUTING9;
		10:
		PH_ROUTE := GVLPHASES.PH_ROUTE10;
		PH_ROUTING := GVLPHASES.PH_ROUTING10;
		11:
		PH_ROUTE := GVLPHASES.PH_ROUTE11;
		PH_ROUTING := GVLPHASES.PH_ROUTING11;
		12:
		PH_ROUTE := GVLPHASES.PH_ROUTE12;
		PH_ROUTING := GVLPHASES.PH_ROUTING12;
	END_CASE;
END_IF;
IF MYFERTNMB =1 THEN
	UN_DS := GVLEQUIP.UN_DS3;
	PHU_MIX := GVLPHASES.PHU_MIX1;
ELSIF MYFERTNMB = 2 THEN
	UN_DS := GVLEQUIP.UN_DS4;
	PHU_MIX := GVLPHASES.PHU_MIX2;	  
END_IF;
PH_WTRDOWN:=GVLPHASES.PH_WTRDOWN;
PH_WTRACID:=GVLPHASES.PH_WTRACID; 

CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT.1:=TRUE;
CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT.2:=TRUE;
CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT.3:= (UN_DS.RECIPEID = MYID);
CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT.4:= (EM_500.RECIPEID = MYID) ;
CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT.5:=(UN_GRN.RECIPEID = MYID); 

//умови блокування на дозвіл запуску
CTRL.ENBL:=TRUE;
IF FALSE  THEN // 
	;
END_IF;

IF CTRL.STA_IDLE THEN
	CTRLRECIPE.STEP2:=0;CTRLRECIPE.TSTEP2:=0;
	CTRL.PAUSING_CMPLT:=FALSE;
	CTRL.RUNING_CMPLT:=FALSE;
	CTRL.HL_RUNNING_CMPLT:=FALSE;
	CTRL.RESTARTING_CMPLT:=FALSE;
	CTRL.HOLDING_CMPLT:=FALSE;
	CTRL.STOPPING_CMPLT:=FALSE;
	CTRL.ABORTING_CMPLT:=FALSE;
	CTRLRECIPE.BATCHID1:=0;//4.04
	CTRLRECIPE.BATCHID2:=0;//4.04
	CTRLRECIPE.PH_ROUTE.HL_RUNNING_CMPLT := FALSE;
	CTRLRECIPE.PH_WTRDOWN.HL_RUNNING_CMPLT :=FALSE ;
	CTRLRECIPE.PHU_GRN.HL_RUNNING_CMPLT := FALSE;
	CTRLRECIPE.PHU_MIX.HL_RUNNING_CMPLT := FALSE;
	CTRLRECIPE.PH_WTRACID.HL_RUNNING_CMPLT := FALSE;	
END_IF;

IF CTRL.STA_RUNNING	THEN
(*на будь якому кроці контроль виконання етапів*)
	CASE CTRLRECIPE.STEP2 OF
		0://ініт
		CTRLRECIPE.STEP2:=1;	CTRLRECIPE.TSTEP2:=0;
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ :=0;
		CTRLRECIPE.EQUIMENTS_ALLOC_CMPLT:=0;
		//----------------- 04.04
		CTRLRECIPE.BATCHID1 := SHL(UINT_TO_UDINT(GVL.PLC.NOW.wMonth),24) + 
							   SHL(UINT_TO_UDINT(GVL.PLC.NOW.wHour),16)	+
							   SHL(UINT_TO_UDINT(GVL.PLC.NOW.wMinute),8) +
							   SHL(UINT_TO_UDINT(GVL.PLC.NOW.wSecond),0) ; //6#MMHH_MMSS,  
		(*16#0R0T_0UMM
		R – номер рецептурного елементу T – номер теплиці U – номер апарату з добривами (0 – без, 1 – DS3, 2 - DS4)
		MM – номер майстер рецепту (0 – створений на базі пустого рецепту) 
		*)  
		CTRLRECIPE.BATCHID2 := SHL(INT_TO_UDINT(MYID),24) + 
							   SHL(INT_TO_UDINT(MYGRNNMB),16)	+
							   SHL(INT_TO_UDINT(MYFERTNMB),8) ; //		
		GVL.CTRLRECIPE_REPORTS[MYID].BATCHID1:=CTRLRECIPE.BATCHID1;
		GVL.CTRLRECIPE_REPORTS[MYID].BATCHID2:=CTRLRECIPE.BATCHID2;
		GVL.CTRLRECIPE_REPORTS[MYID].FORMULA := FORMULA;
		GVL.CTRLRECIPE_REPORTS[MYID].STARTDATE := GVL.PLC.NOW;
		GVL.CTRLRECIPE_REPORTS[MYID].FQGRN:=MYGRNNMB;
		GVL.CTRLRECIPE_REPORTS[MYID].RECIPEID:=MYID;
		GVL.CTRLRECIPE_REPORTS[MYID].PRM := CTRLRECIPE.PRM;
		GVL.CTRLRECIPE_REPORTS[MYID].HLDCOUNT :=0;
		GVL.CTRLRECIPE_REPORTS[MYID].FQGRN := 0;
		1: //очікування обладнання 
		//якщо обладнання нами зайняте (окрім шарового) - переход на інший крок
		(*X1: подача води, X2: pH, X3: фертигація, X4: блок перемикання, X5: машини полив*)
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ.1:=TRUE;
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ.2:=TRUE;
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ.3:= (MYFERTNMB > 0);
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ.4:=TRUE;
		CTRLRECIPE.EQUIMENTS_ALLOC_REQ.5:=TRUE;

		//UN_GRN.RECIPEID = MYID
		IF UN_GRN.RECIPEID = MYID AND ////перевірка поливочних машин 
			(UN_DS.RECIPEID = MYID OR MYFERTNMB=0) AND //перевірка фертигації
			EM_500.RECIPEID = MYID THEN //перевірка блоку перемикачів
			CTRLRECIPE.STEP2:=2; CTRLRECIPE.TSTEP2:=0;
		END_IF;		
		2: // ініціалізація етапів/процедур (для ексклюзивних очікування IDLE), для шарових IDLE або RUNNING  
			IF PHU_GRN.STEP1=1 AND (PHU_MIX.STEP1=1 OR MYFERTNMB=0) AND PH_ROUTE.STEP1=1 AND PH_ROUTING.STEP1=1 AND
				(PH_WTRDOWN.STEP1=1 OR PH_WTRDOWN.STEP1=2 OR PH_WTRDOWN.STEP1=8 OR PH_WTRDOWN.STEP1=10 OR PH_WTRDOWN.STEP1=12) AND 
				(PH_WTRACID.STEP1=1 OR PH_WTRACID.STEP1=2 OR PH_WTRACID.STEP1=8 OR PH_WTRACID.STEP1=10 OR PH_WTRACID.STEP1=12)THEN 
				CTRLRECIPE.STEP2:=3; CTRLRECIPE.TSTEP2:=0;
			END_IF;
		3: // записування формули  
		IF PHU_GRN.STA.7 AND (PHU_MIX.STA.7 OR MYFERTNMB=0) AND PH_ROUTE.STA.7 THEN;
			CTRLRECIPE.STEP2:=4; CTRLRECIPE.TSTEP2:=0;
		END_IF
		4: // запуск на виконання
			CTRLRECIPE.PH_ROUTE.CMD_START := TRUE;
			CTRLRECIPE.PH_WTRDOWN.CMD_START := TRUE;
	//		CTRLRECIPE.PHU_GRN.CMD_START := TRUE;
			CTRLRECIPE.PHU_MIX.CMD_START := TRUE;
			CTRLRECIPE.PH_WTRACID.CMD_START := TRUE;
			CTRLRECIPE.STEP2:=41; CTRLRECIPE.TSTEP2:=0;
		41: IF MYFERTNMB=0 OR PHU_MIX.CMD=513 OR PHU_MIX.CMD=514 THEN
			CTRLRECIPE.PHU_GRN.CMD_START := TRUE;
			CTRLRECIPE.STEP2:=5; CTRLRECIPE.TSTEP2:=0;
		END_IF;
	//	IF PH_ROUTE.STEP1 = 2 AND PH_WTRDOWN.STEP1 =2 AND PH_WTRACID.STEP1=2 AND PHU_GRN.STEP1=2 AND PHU_MIX.STEP1=2 THEN 
	//		CTRLRECIPE.STEP2:=5; CTRLRECIPE.TSTEP2:=0;
	//	END_IF;
	//	IF PHU_GRN.STEP1=8 OR PHU_GRN.STEP1=1 THEN
	//		CTRLRECIPE.STEP1:=8;
		//END_IF; 
		5: // робота
		//умова завершення - це завершення поливу
		IF PHU_GRN.STEP1=8 (*OR PHU_GRN.STEP1=1*) THEN
			CTRLRECIPE.STEP1:=8;
		END_IF; 
		(*0 – резерв, не використовується (сіреневий)
		1 – Idle (очікування) – світлосірий 
		2 - Running – зелений 
		3 – Pausing – жовтий моргаючий 
		4 – Paused – оранжовий 
		7 – Restarting – зелений моргаючий 
		8 – Complete (темносиній)
		*)
		//5,6 HOLD
		IF PH_ROUTE.STEP1 = 5 OR PH_ROUTE.STEP1 = 6 OR 
			PH_WTRDOWN.STEP1 = 5 OR PH_WTRDOWN.STEP1 = 6 OR
			PHU_GRN.STEP1 = 5 OR PHU_GRN.STEP1 = 6 OR
			PHU_MIX.STEP1 = 5 OR PHU_MIX.STEP1 = 6 OR
			PH_WTRACID.STEP1 = 5 OR PH_WTRACID.STEP1 = 6 THEN
			CTRL.CMD_HOLD:=TRUE;
			GVL.CTRLRECIPE_REPORTS[MYID].HLDCOUNT:=GVL.CTRLRECIPE_REPORTS[MYID].HLDCOUNT+1;
		END_IF;
		//9,10 STOP
		IF PH_ROUTE.STEP1 = 9 OR PH_ROUTE.STEP1 = 10 OR
			PH_WTRDOWN.STEP1 = 9 OR PH_WTRDOWN.STEP1 = 10 OR
			PHU_GRN.STEP1 = 9 OR PHU_GRN.STEP1 = 10 OR
			PHU_MIX.STEP1 = 9 OR PHU_MIX.STEP1 = 10 OR
			PH_WTRACID.STEP1 = 9 OR PH_WTRACID.STEP1 = 10 THEN
			CTRL.CMD_STOP:=TRUE;		
		END_IF;
		 
		//11,12 ABORT
		IF PH_ROUTE.STEP1 = 11 OR PH_ROUTE.STEP1 = 12 OR
			PH_WTRDOWN.STEP1 = 11 OR PH_WTRDOWN.STEP1 = 12 OR
			PHU_GRN.STEP1 = 11 OR PHU_GRN.STEP1 = 12 OR
			PHU_MIX.STEP1 = 11 OR PHU_MIX.STEP1 = 12 OR
			PH_WTRACID.STEP1 = 11 OR PH_WTRACID.STEP1 = 12 THEN
			CTRL.CMD_ABORT:=TRUE;						
		END_IF;

	ELSE
		CTRLRECIPE.STEP2:=0;
	END_CASE;	
	//умова нормального завершення етапу
	 
END_IF;
IF CTRL.STA_COMPLETE THEN
	CTRLRECIPE.PH_ROUTE.HL_RUNNING_CMPLT := TRUE;
	CTRLRECIPE.PH_WTRDOWN.HL_RUNNING_CMPLT := TRUE;
	CTRLRECIPE.PHU_GRN.HL_RUNNING_CMPLT := TRUE;
	CTRLRECIPE.PHU_MIX.HL_RUNNING_CMPLT := TRUE;
	CTRLRECIPE.PH_WTRACID.HL_RUNNING_CMPLT := TRUE;			
	CTRLRECIPE.STEP2:=0;
	IF CTRLRECIPE.TSTEP2>5 THEN  
		FORMULA.GRN_NMB:=0;
		FORMULA.FERT_NMB:=0;
		CTRL.CMD_RESET:=TRUE;
		GVL.CTRLRECIPE_REPORTS[MYID].STOPCAUSE := 8; RECIPE_REC_ARCHIVE(MYID);	
	END_IF;
END_IF;

//в станах PAUSING 
IF CTRL.STA_PAUSING THEN
	CTRL.PAUSING_CMPLT := TRUE;
END_IF;
IF CTRL.STA_PAUSED THEN
	;
END_IF;

//в стані HOLDING  
IF CTRL.STA_HOLDING THEN
	CTRLRECIPE.PH_ROUTE.CMD_HOLD := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_HOLD := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_HOLD := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_HOLD := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_HOLD := TRUE;			
	IF CTRLRECIPE.PH_ROUTE.STA_HOLD AND 
 		(*CTRLRECIPE.PH_WTRDOWN.STA_HOLD AND*)
		CTRLRECIPE.PHU_GRN.STA_HOLD AND
		CTRLRECIPE.PHU_MIX.STA_HOLD AND
		TRUE (*CTRLRECIPE.PH_WTRACID.STA_HOLD*) THEN
		CTRL.HOLDING_CMPLT:=TRUE;
	END_IF;
END_IF;
IF CTRL.STA_HOLD THEN //в стані HOLD тримати все відключеними  
	CTRLRECIPE.PH_ROUTE.CMD_HOLD := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_HOLD := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_HOLD := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_HOLD := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_HOLD := TRUE;			
END_IF;
IF CTRL.STA_RESTARTING THEN //в стані RESTARTING перейти в Running  
	CTRLRECIPE.PH_ROUTE.CMD_RESTART := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_RESTART := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_RESTART := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_RESTART := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_RESTART := TRUE;
	IF CTRLRECIPE.PH_ROUTE.STA_RUNNING AND 
 		CTRLRECIPE.PH_WTRDOWN.STA_RUNNING AND
		CTRLRECIPE.PHU_GRN.STA_RUNNING AND
		CTRLRECIPE.PHU_MIX.STA_RUNNING AND
		CTRLRECIPE.PH_WTRACID.STA_RUNNING THEN			
		CTRL.RESTARTING_CMPLT:=TRUE;
	END_IF;	
END_IF;

//в стані STOPPING датик команду на закриття клапану і перейти в STOP
IF CTRL.STA_STOPPING THEN
	CTRLRECIPE.PH_ROUTE.CMD_STOP := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_STOP := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_STOP := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_STOP := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_STOP := TRUE;
	IF CTRLRECIPE.PH_ROUTE.STA_STOPPED AND 
 		(*CTRLRECIPE.PH_WTRDOWN.STA_STOPPED AND*)
		CTRLRECIPE.PHU_GRN.STA_STOPPED AND
		CTRLRECIPE.PHU_MIX.STA_STOPPED AND
		TRUE (*CTRLRECIPE.PH_WTRACID.STA_STOPPED*) THEN
		CTRL.STOPPING_CMPLT:=TRUE;
		GVL.CTRLRECIPE_REPORTS[MYID].STOPCAUSE := 9; RECIPE_REC_ARCHIVE(MYID);
	END_IF;
END_IF;
IF CTRL.STA_STOPPED THEN
	CTRLRECIPE.STEP2:=0;
	IF CTRLRECIPE.TSTEP2>5 THEN  
		FORMULA.GRN_NMB:=0;
		FORMULA.FERT_NMB:=0;
		CTRL.CMD_RESET:=TRUE;
	END_IF;	
END_IF

//в станах ABORTING і PAUSING нічого не робити і перейти в наступний стан
IF CTRL.STA_ABORTING THEN
	CTRLRECIPE.PH_ROUTE.CMD_ABORT := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_ABORT := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_ABORT := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_ABORT := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_ABORT := TRUE;
	CTRL.ABORTING_CMPLT := TRUE;
	GVL.CTRLRECIPE_REPORTS[MYID].STOPCAUSE := 11;	RECIPE_REC_ARCHIVE(MYID);
END_IF;
IF CTRL.STA_ABORTED THEN
	CTRLRECIPE.PH_ROUTE.CMD_ABORT := TRUE;
	CTRLRECIPE.PH_WTRDOWN.CMD_ABORT := TRUE;
	CTRLRECIPE.PHU_GRN.CMD_ABORT := TRUE;
	CTRLRECIPE.PHU_MIX.CMD_ABORT := TRUE;
	CTRLRECIPE.PH_WTRACID.CMD_ABORT := TRUE;
	CTRLRECIPE.STEP2:=0;
	IF CTRLRECIPE.TSTEP2>5 THEN  
		FORMULA.GRN_NMB:=0;
		FORMULA.FERT_NMB:=0;
	END_IF;
END_IF;

RECIPE_PHASE (RECIPE_CTRL:= CTRLRECIPE.PH_ROUTE, PHASE:= PH_ROUTE, PHASE_HMI := CTRLRECIPE.PH_ROUTE_HMI );
RECIPE_PHASE (RECIPE_CTRL:= CTRLRECIPE.PH_WTRDOWN, PHASE:= PH_WTRDOWN, PHASE_HMI := CTRLRECIPE.PH_WTRDOWN_HMI);
RECIPE_PHASE (RECIPE_CTRL:= CTRLRECIPE.PHU_GRN, PHASE:= PHU_GRN, PHASE_HMI := CTRLRECIPE.PHU_GRN_HMI);
RECIPE_PHASE (RECIPE_CTRL:= CTRLRECIPE.PHU_MIX, PHASE:= PHU_MIX, PHASE_HMI := CTRLRECIPE.PHU_MIX_HMI);
RECIPE_PHASE (RECIPE_CTRL:= CTRLRECIPE.PH_WTRACID, PHASE:= PH_WTRACID, PHASE_HMI := CTRLRECIPE.PH_WTRACID_HMI);
(**)
RECIPE(CFG:= CTRLRECIPE, CTRL:=CTRL);

IF PLC.PLS.P1S THEN
    CTRLRECIPE.TSTEP2:=CTRLRECIPE.TSTEP2+1;
    IF CTRLRECIPE.TSTEP2>30000 THEN CTRLRECIPE.TSTEP2:=30000;END_IF;     
END_IF;