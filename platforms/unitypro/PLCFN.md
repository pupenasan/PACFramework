# Клас PLC: програмований контролер 

**CLSID=16#21xx**

## Реалізація



## Тестування PLCFN 

Цей пункт описує методику перевірки функції PLCFN в ручному та/або автоматизованому режимі. 

### Перелік тестів

| Номер | Назва                                                        | Коли перевіряти                                     | Примітки |
| ----- | ------------------------------------------------------------ | --------------------------------------------------- | -------- |
| 1     | перший скан                                                  | після реалізації функції                            |          |
| 2     | астрономічний час                                            | після реалізації функції                            |          |
| 3     | лічильники роботи ПЛК: загальний і зі старту                 | після реалізації функції                            |          |
| 4     | бітові імпульси                                              | після реалізації функції проекту на реальному ПК    |          |
| 5     | бітові меандри                                               | після реалізації функції на реальному ПК            |          |
| 6     | імпульси початку години, доби                                | після реалізації функції                            |          |
| 7     | скидування бітів статусів та лічильників тривог, статусів та збереження їх в змінних `_PERM` | після розгортання базових обєктів каркасу LVL0-LVL2 |          |
| 8     | зміни: номер активної зміни, початок зміни                   | після реалізації функції                            |          |
| 9     | відображення мінімального та максимального часу циклу        | після реалізації функції                            |          |
| 10    | обнулення команд через один цикл                             | після реалізації функції                            |          |

### 1 Тест першого скану

- перед запуском перевірки ПЛК повинен бути в СТОП
- перед викликом функції PLCFN повинна інкрементуватися змінна-лічильник циклів `TST_CCLS`, яка перед запуском ПЛК, повинна =0
- після виклику функції PLCFN при умові, що біт SCN1=TRUE:
  - збільшувати змінну `TST_SCN1CLC` (кількість викликів "першого циклу") на 1 
  - присвоїти змінній `TST_NBCLC := TST_CCLS` (останній номер циклу при спрацюванні біта першого циклу)

- після запуску ПЛК `TST_CCLS` повинен збільшуватися, а  `TST_SCN1CLC=1`, `TST_NBCLC=1`

| Крок | дія для перевірки                       | результат                                         |
| ---- | --------------------------------------- | ------------------------------------------------- |
| 1    | обнулити тестові змінні за необхідності |                                                   |
| 2    | запустити ПЛК (імітатор)                |                                                   |
| 3    | перевірити змінні                       | TST_CCLS збільшується, TST_SCN1CLC=1, TST_NBCLC=1 |

### 2 Тест астрономічного часу

Перевіряється рівність дати часу відповідним полям структури NOW у форматі BCD.

### 3 Тест лічильників роботи ПЛК

Лічильник `TQM` не повинен обнулятися при перезапуску ПЛК, а `TQ` повинен. Реалізація `TQM` потребує збереження її в енергонезалежній пам'яті без обнулення при запуску. 

Загальна методика передбачає запуск ПЛК, перевірку `TQ` та `TQM` через кілька хвилин роботи. `TQ` повинен збільшуватися з кожною секундою, `TQM` з кожною хвилиною (або на початку хвилини, це не особиво впливає на точність). При зупинці і запуску ПЛК, лічильник `TQ` має обнулитися і запуститися заново. `TQM` повинен продовжити рахувати з того самого значення. 

Точність `TQ` перевіряється астрономічним годинником. 

Перевіряється чи час циклу дорівнює різниці часів реального часу між двома викликами.

### 4 Тест бітових імпульсів

- Перевіряється робота бітових імпульсів `P100MS`, `P200MS`, `P500MS`, `P1S`, `P2S`, `P5S`, `P10S`, `P60S`. Імпульси повинні спрацьовувати на один цикл з вказаною періодичністю. Враховуючи прив'язаність до обладнання коректність роботи може гарантуватися тільки на реальному залізі.
- Повторну перевірку варто робити  після реалізації всієї програми користувача, так як об'єм програми впливає на час циклу.   

- Для кожного імпульсу вводиться по одному тестовому лічильнику `TST_P100MS`, `TST_P200MS`, `TST_P500MS`, `TST_P1S`, `TST_P2S`, `TST_P5S`, `TST_P10S`, `TST_P60S`. Також вводиться додаткова змінна `TST_PLSON`, яка забезпечує інтервал тестування. Дана змінна включається для запуску тестування і відключається автоматично при зупинці тестування. 


- Для тестування використовується змінна `TQ` як показник часу. Але точніше буде використовувати системний час. Перевіряється проходження 121 с. Оцінюється приблизна кількість спрацювань з урахуванням похибки.


Якщо кількість імпульсів відрізняється від показника в таблиці, наведеній нижче:

- перевірити правильність реалізації
- якщо реалізація правильна, то очевидно час циклу більше за 2 інтервали бітового імпульсу, треба оцінювати доцільність використання цих бітів в програмі користувача або перевіряти їх на реальному ПЛК (якщо був використаний до цього імітатор)    

### 5 Тест бітових меандрів

Перевіряються бітові меандри `M1S` та `M2S`. Найпростіше їх перевірити візуально. Їх призначення виключно для локальних засобів ЛМІ (наприклад лампи), тому візуальна перевірка є достатньою.

### 6 Тест імпульсів початку години та доби

Цей тест потребує зміни значення часу в ПЛК або імітаторі.

Перевірка зміни години `NEWHR` перевіряється на першій хвилині (спрацьовує один раз на першій хвилині), доби `NEWDAY` - на першій хвилині першої години доби (спрацьовує один раз на першій хвилині). 

Змінна `TST_CHHRCNT` збільшується на 1 при зміні години, `TST_CHDAYCNT` при зміні доби.

### 7 Тест скидування бітів статусів та лічильників тривог і статусів

Усі біти тривог а також біти статусів повинні бути обнулені після виклику функції. Змінні "_PERM" (`STA_PERM` та `ALM1_PERM`) зберігають значення до наступного виклику функції.

Усі лічильники повинні бути скинуті. 

### 8 Перевірка зміни

Перевірка на адекватну поведінку, якщо кількість змін `SHIFT[0]` буде некоректною. Перевірити переключення на кожну зміну.

### 9 Тест відображення мінімального та максимального часу циклу

Перевірити співпадіння мінімального та максимального значення часу задачі

### 10 Обнулення команд через один цикл

Перевірити проходження команд протягом одного циклу. Це потрібно для відловлення широкомовних команд. 

Після виклику функції вставляється лічильник коли `PLC.CMD<>0`. Якщо лічильник збільшується на 1 після кожного виклику команди - все нормально.
