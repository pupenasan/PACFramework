# Розгортання PACFramework у проекті Citect Situational Awareness

## Загальні принципи адаптації

PACFramework призначений перш за все для розробки прикладного ПЗ для ПЛК. Тим не менше багато сучасних SCADA програм передбачають нові підходи до побудови високоефективних людино-машинних інтерфейсів, які у свою чергу потребують підтримки з боку ПЛК. Серед таких - Aveva Plant SCADA (раніше Citect) Situational Awareness. Це новий шаблон в новій версії SCADA Citect і формально в новій SCADA з іншою назвою. Надалі в цьому описі він буде називатися `Citect SA`, щоб показати спорідненість з Citect.

Окрім нових підходів Citect SA базується на бібліотеці композитних джинів, які відповідають за різні типи об'єктів - вимірювальних приладів, виконавчих механізмів і т.п. Кількість таких об'єктів досить велика і вони у свою чергу спираються на відповідні шаблони Equipment (обладнання, устатковання). Це повністю відповідає концепції PACFramework, де кожен об'єкт каркасу є також устаткованням. По факту ці Equipment відповідають аналогічним з рівня LVL1 (тльки AIVAR) та LVL2 (пристрої). Відповідність не є прямою, але за рахунок гнучкості PACFramework можна привести  PACFramework до Citect SA та навпаки. У PACFramework треба реалізувати додаткову функцію на рівні ПЛК (детальніше в описі нижче) а в Citect SA трохи змінити шаблони Equipment. При цьому бібліотечні композитні джини можна взагалі не змінювати, їх функціональність підтримується повністю на рівні шаблону.

Додатково можна змінити кольорову палітру в ряді композитних джинів. Для цього є відповідні композитні джини з суфіксом PFW (поки не реалізовано). Це зумовлено особливістю вибраної кольорової палітри в Citect SA (темний - активний, світлий - пасивний).                     

- [Загальні властивості та налаштування Citect SA](cm_common.md)
- [Адаптація Meters до AI_VAR](cm_aivar.md)
- [Адаптація приводних об'єктів](cm_drive.md)
- [Адаптація клапанів](cm_valve.md)

## Опис шаблонного проекту для адаптації

Розробка проекту SA з PACFramework проводиться шляхом попереднього включення в проект шаблонного проекту  `SA_LibraryPFW`, який містить необхідні бібліотечні елементи та скрипти.

### Перелік типів Equipment

- DIVAR_HMI - відповідно до DIVAR_HMI ПЛК

- AIVAR_HMI - відповідно до AIVAR_HMI ПЛК

- DOVAR_HMI - відповідно до DOVAR_HMI ПЛК

- AOVAR_HMI - відповідно до AOVAR_HMI ПЛК

- PARASHMI - спеціальна змінна для фонового обміну конфігураційними параметрами

- VARBUF - відповідно до VARBUF ПЛК

- CH_BUF - відповідно до CH_BUF ПЛК

- MODULE - відповідно до MODULE ПЛК

- PLC - відповідно до PLC ПЛК

- SUBMODULE - відповідно SUBMODULE ПЛК


### Перелік функцій

Усі базові функції PACFramework розміщені у файлі `PFW_base.ci`

- 

## Послідовність розгортання SA_LibraryPFW з використанням PACFramework Tools

Нижче наведена послідовність розгортання проекту з використанням безкоштовної утиліти PACFramework Tools

### 1. Створення проекту на базі SA

- [ ] Створіть новий проект на базі стартового проекту SA  
- [ ] Створіть одного користувача з правами (на базі ролі) адміністратора
- [ ] Створіть новий I/O Device, з яким буде відбуватися зв'язок, приклад розроблений з урахуванням Modbus TCP/IP
- [ ] Скомпілюйте проект, щоб перевірити що немає помилок
- [ ] Зробіть бекап проекту.

**Увага, з метою уникнення втрати даних, робіть резервну копію перед виконанням кожного пункту!**

### 2. Завантаження та встановлення PACFramework Tools

Каркас НЕ передбачає обов'язкове використання утиліт розгортання (PACFramework tools), але це значно пришвидшує розробку. Тому в даній роботі передбачається використання автоматичних утиліт розгортання [pacframework-tools](https://github.com/pupenasan/pacframework-tools).

- [ ] Встановіть утиліти, як це описано в [репозиторії](https://github.com/pupenasan/pacframework-tools), скористайтеся рекомендованим скриптом
- [ ] Перейдіть до створеної директорії в домашній папці, створіть там директорію з іменем `source`
- [ ] Відкрийте файл налаштування `config.ini` перевірте і виправте налаштування і збережіть файл:

```ini
[citecttools]
plcsourcepath = C:\Users\user\pacframeworktools\result
pathresult = C:\Users\user\pacframeworktools\result
pathlog = C:\Users\user\pacframeworktools\log
pathmasterdbf = C:\ProgramData\AVEVA Plant SCADA 2020 R2\User
ctprojectname = ExampleSA
pfwincludename = SA_LibraryPFW
iodevicename = M340; IODeviceName
cntelemetspergenie = dicnt:8,docnt:8,aicnt:4,aocnt:4 ;кількість елементів на кожен джин
```

### 3. Формування вихідних даних для PACFramework Tools

Для розгортання проекту необхідно в ресурсну директорію помістити файл експорту проекту ПЛК. Нижче розглядається тільки проект експорту з Unity PRO (Control Expert). Щодо інших варіантів платформ, уточнюйте у розробників або читайте відповідні розділи репозиторію.

- [ ] Відкрийте Unity PRO (Control Expert) і зробіть експорт проекту в папку що вказана в ini-файлі як `plcsourcepath` та іменем `export.xef`

### 4. Включення SA_LibraryPFW

- [ ] Завантажте останню версію `SA_LibraryPFW`, який містить усі необхідні скрипти та бібліотечні елементи, та відновіть в робочий простір Citect 
- [ ] Включіть проект `SA_LibraryPFW` у свій власний

**Увага! Даний проект не буде компілюватися, якщо після цього пункту не зробити мінімальні дії щодо створення Equipments.**

### 5. Формування Equipment

Є дві групи утиліти PACFramework Tools для роботи з Citect SA:

- робота з базою даних проекту
- робота з графікою

Ці утиліти запускаються окремо, так як виконують різного роду діяльність і часто потребують діяльності розробника. 

- [ ] Запустіть утиліту формування Equipment:

```bash
node index citectcreateeqip
```

- [ ] Подивіться в консолі утиліти журнал помилок, якщо помилок немає, перейдіть до наступного пункту
- [ ] Відкрийте Equipment Editor. Зверніть увагу, що усі Equipmnet формуються в кореневому об'єкті temp. Після формування об'єкти можна розмістити у відповідному місці ієрархії пізніше. У демонстраційному проекті це робити не обов'язково.

### 6. Генерування тегів

- [ ]  В Citect зробіть `Update Equipment`
- [ ] Зробіть компілювання проекту. Якщо помилок немає переходьте до наступного пункту.

### 7. Генерування джинів для HMI

- [ ] Запустіть утиліту формування Genie для налагодження:

```bash
node index citectcreatehmi
```

Утиліта може працювати кілька хвилин, процес формування джинів можна проконтролювати відкривши Graphics Builder.

- [ ] Дочекайтеся повідомлення про формування джинів. Не повинно бути ніяких повідомлень, окрім результату формування джинів формату:

```
Genie AIVAR1 saved
```

Враховуючи, що у випадку змін необхідно змінювати тільки частину сторінок налагодження каркасу, окрім команди `citectcreatehmi` є також наступні команди:

- `node index citectcreatevarhmi` - карта змінних 
- `node index citectcreateplcmaphmi` - карта каналів ПЛК
- `node index citectcreateacthmi` - конфігурування виконавчих механізмів

### 8. Створення сторінок HMI

- [ ] Створіть кілька сторінок для розміщення джинів. Рекомендується за наступним форматом:
  - [ ] AIVAR1 ...AIVARn - сторінки для налагодження AIVAR 
  - [ ] DIVAR1 ...DIVARn - сторінки для налагодження DIVAR 
  - [ ] AOVAR1 ...AOVARn - сторінки для налагодження AOVAR 
  - [ ] DOVAR1 ...DOVARn - сторінки для налагодження AOVAR 
  - [ ] PLCMAP1...PLCMAPn - сторінки для налагодження каналів
  - [ ] Кілька сторінок для налагодження ВМ

- [ ] Розмістіть на сторінках створені джини та джин буферу відповідного типу. Буфери прив'яжуть до відповідних змінних.  
- [ ] У розділі Citect Visualization->Menu Configuration створіть пункт меню Navigation 

### 9. Запуск проекту

- [ ] Скомпілюйте проект
- [ ] Запустіть проект на виконання, при першому запуску налаштуйте майстер 

## Послідовність зміни проекту на базі SA_LibraryPFW з використанням PACFramework Tools

Нижче наведена послідовність повторного розгортання проекту з використанням безкоштовної утиліти PACFramework Tools за умови що проект вже розгортався.

- [ ] Відкрийте Unity PRO (Control Expert) і зробіть експорт проекту в папку що вказана в ini-файлі як `plcsourcepath` та іменем `export.xef`
- [ ] Запустіть утиліту формування Equipment (**УВАГА! Існуючі Equipment, які були видалені в проекті ПЛК з Citect не видаляються!**):

- Усіх Equipment, якщо потрібно змінити все:

```bash
node index citectcreateeqip
```

- Потрібні Equipment, які необхідно змінити, у цьому випадку запустіть ті утиліти, які потрібноз списку:
  - `citectcreatevareqip` - для технологічних змінних
  - `citectcreatemoduleeqip` - для карти каналів ПЛК
  - `citectcreateacteqip` - для ВМ

- [ ] В Citect зробіть `Update Equipment`.
- [ ] Видаліть непотрібні (старі) Equipment, якщо їх не планується задіювати в проекті 
- [ ] Зробіть компілювання проекту. Якщо помилок немає переходьте до наступного пункту.

- [ ] Запустіть утиліту формування Genie для налагодження для вибраного Вами варіанту:

- Якщо треба обновити усі джини для PACFramework:

```bash
node index citectcreatehmi
```

- Якщо треба обновити тільки вибрані джини для PACFramework:

- `citectcreatevarhmi` - для налагодження технологічних змінних
- `citectcreateplcmaphmi` - для налагодження карти ПЛК
- `citectcreateacthmi` - для налагодження ВМ

- [ ] В редакторі графіки запустіть оновлення усіх сторінок
- [ ] Скомпілюйте проект
